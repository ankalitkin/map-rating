(function(e){function t(t){for(var r,i,o=t[0],s=t[1],u=t[2],p=0,h=[];p<o.length;p++)i=o[p],Object.prototype.hasOwnProperty.call(n,i)&&n[i]&&h.push(n[i][0]),n[i]=0;for(r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r]);l&&l(t);while(h.length)h.shift()();return c.push.apply(c,u||[]),a()}function a(){for(var e,t=0;t<c.length;t++){for(var a=c[t],r=!0,o=1;o<a.length;o++){var s=a[o];0!==n[s]&&(r=!1)}r&&(c.splice(t--,1),e=i(i.s=a[0]))}return e}var r={},n={app:0},c=[];function i(t){if(r[t])return r[t].exports;var a=r[t]={i:t,l:!1,exports:{}};return e[t].call(a.exports,a,a.exports,i),a.l=!0,a.exports}i.m=e,i.c=r,i.d=function(e,t,a){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},i.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(i.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(a,r,function(t){return e[t]}.bind(null,r));return a},i.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/map-rating/";var o=window["webpackJsonp"]=window["webpackJsonp"]||[],s=o.push.bind(o);o.push=t,o=o.slice();for(var u=0;u<o.length;u++)t(o[u]);var l=s;c.push([0,"chunk-vendors"]),a()})({0:function(e,t,a){e.exports=a("cd49")},"034f":function(e,t,a){"use strict";a("85ec")},"85ec":function(e,t,a){},cd49:function(e,t,a){"use strict";a.r(t);a("e260"),a("e6cf"),a("cca6"),a("a79d");var r=a("2b0e"),n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("v-app",[a("v-main",[a("Home")],1)],1)},c=[],i=a("d4ec"),o=a("262e"),s=a("2caf"),u=a("9ab4"),l=a("1b40"),p=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("div",{staticStyle:{height:"800px","z-index":"1"},attrs:{id:"map"}}),a("div",{staticClass:"pa-4",staticStyle:{"z-index":"2",position:"fixed",left:"0",bottom:"0"}},[a("v-btn",{attrs:{disabled:!1},on:{click:e.paint}},[e._v("Раскрасить карту")]),a("span",{staticClass:"ml-4"},[e._v(e._s(e.state))]),a("v-radio-group",{model:{value:e.selected_case,callback:function(t){e.selected_case=t},expression:"selected_case"}},e._l(e.Preferences.cases,(function(e,t){return a("v-radio",{key:t,attrs:{label:e.name,value:t}})})),1)],1)])},h=[],f=a("1da1"),g=a("bee2"),m=(a("96cf"),a("d81d"),a("b680"),a("d3b7"),a("e11e")),d=(a("159b"),a("4de4"),a("b64b"),a("ac1f"),a("1276"),a("99af"),a("a15b"),a("5db7"),a("73d9"),a("498a"),function e(){Object(i["a"])(this,e)});d.groups={public_transport:{name:"Общественный транспорт",tags:["highway: bus_stop"]},grocery:{name:"Магазины и рынки",tags:["shop: convenience","shop: supermarket","amenity: marketplace"]},pharmacy:{name:"Аптеки",tags:["amenity: pharmacy","healthcare: pharmacy"]},food:{name:"Кафе и быстрое питание",tags:["amenity: fast_food","amenity: cafe"]},kindergarten:{name:"Детские сады",tags:["amenity: kindergarten"]},school:{name:"Школы",tags:["amenity: school"]},clinic:{name:"Больницы и поликлиники",tags:["amenity: clinic","amenity: hospital","amenity: doctor","amenity: doctors","healthcare: clinic","healthcare: hospital","healthcare: doctor","healthcare: doctors","healthcare: centre"]},hairdresser:{name:"Парикмахерские",tags:["shop: hairdresser"]},cinema:{name:"Кино",tags:["amenity: cinema"]},pub:{name:"Пабы и бары",tags:["amenity: pub","amenity: bar"]},nightclub:{name:"Ночные клубы",tags:["amenity: nightclub"]}},d.cases=[{name:"Семьянин",groupsNames:["grocery","pharmacy","clinic","kindergarten","school","hairdresser","public_transport"]},{name:"Ответственный студент",groupsNames:["grocery","pharmacy","clinic","food","public_transport"]},{name:"Безответственный студент",groupsNames:["grocery","pharmacy","clinic","food","cinema","pub","nightclub","public_transport"]}];var v=a("e1ab"),y=a("92e0"),b=a.n(y),w=a("b946"),O=function(){function e(){Object(i["a"])(this,e)}return Object(g["a"])(e,null,[{key:"loadAmenities",value:function(){var t=Object(f["a"])(regeneratorRuntime.mark((function t(a){var r,n,c,i,o=this;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.queryData(a);case 2:r=t.sent,n={},c={},e.cacheDistances(a),r.elements.forEach((function(t){var a=t,r=a.tags;Object.keys(r).filter((function(e){return o.accepted.indexOf(e)>=0})).forEach((function(t){r[t].split(/[;, ]/).forEach((function(r){var c="".concat(t,": ").concat(r);Object.keys(d.groups).forEach((function(t){if(d.groups[t].tags.indexOf(c)>=0){t in n||(n[t]=[]);var r=e.getXY(e.getLatLng(a));n[t].push(r)}}))}))}))})),i=function(e,t){return Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)},Object.keys(n).forEach((function(e){n[e].length>4e3&&(c[e]=new w["kdTree"](n[e],i,["x","y"]))})),e.amenitiesList=n,e.amenitiesTree=c;case 11:case"end":return t.stop()}}),t)})));function a(e){return t.apply(this,arguments)}return a}()},{key:"cacheDistances",value:function(t){var a={unit:"meter",format:"[lat,lon]"};e.calcCache.metersPerLatDeg=b()([t[0],t[1]],[t[2],t[1]],a)/(t[2]-t[0]),e.calcCache.metersPerLngDeg=b()([t[0],t[1]],[t[0],t[3]],a)/(t[3]-t[1])}},{key:"getAverageRating",value:function(t,a){var r=this,n=t.groupsNames.filter((function(t){return t in e.amenitiesList})).map((function(t){var n=t in r.amenitiesTree?e.getRatingByGroupNameTree:e.getRatingByGroupNameList;return n(t,a)})).reduce((function(e,t){return e+t}),0);return n/t.groupsNames.length}},{key:"getCachedQuery",value:function(){return localStorage.getItem("cachedQuery")}},{key:"createQuery",value:function(e){var t=[],a=[],r="[out:json][bbox:".concat(e.join(","),"];(\n");Object.keys(d.groups).flatMap((function(e){return d.groups[e]})).flatMap((function(e){return e.tags})).forEach((function(e){var r=e.indexOf(":"),n=e.substring(0,r).trim();t.indexOf(n)<0&&t.push(n);var c=e.substring(r+1).trim();a.indexOf(c)<0&&a.push(c)}));var n='~"^('.concat(t.join("|"),')$"~"^(').concat(a.join("|"),')$"');return r+="node[".concat(n,"];\n"),r+="way[".concat(n,"];\n"),r+="relation[".concat(n,"];\n"),r+=");out center;",r}},{key:"getLatLng",value:function(e){if("node"===e.type)return[e.lat,e.lon];if("way"===e.type||"relation"===e.type){if(!e.center)throw new Error("No center data provided");return[e.center.lat,e.center.lon]}throw new Error("Invalid element type")}},{key:"queryData",value:function(){var t=Object(f["a"])(regeneratorRuntime.mark((function t(a){var r,n,c;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.createQuery(a),e.getCachedQuery()!==r){t.next=5;break}if(n=localStorage.getItem("cachedData"),!n){t.next=5;break}return t.abrupt("return",JSON.parse(n));case 5:return t.next=7,Object(v["a"])(r);case 7:c=t.sent;try{localStorage.setItem("cachedQuery",r),localStorage.setItem("cachedData",JSON.stringify(c))}catch(i){console.warn("Cannot save loaded data to cache"),localStorage.removeItem("cachedQuery"),localStorage.removeItem("cachedData")}return t.abrupt("return",c);case 10:case"end":return t.stop()}}),t)})));function a(e){return t.apply(this,arguments)}return a}()},{key:"calcTimeMinutes",value:function(e){return e/5e3*60}},{key:"calcRating",value:function(e){return e<2.5?5:12.5/e}},{key:"getXY",value:function(t){return{x:t[1]*e.calcCache.metersPerLngDeg,y:t[0]*e.calcCache.metersPerLatDeg}}},{key:"getMinimalDistanceMetersTree",value:function(t,a){var r=t.nearest(e.getXY(a),1);return Math.sqrt(r[0][1])}},{key:"getMinimalDistanceMetersList",value:function(t,a){var r=1/0,n=e.getXY(a);return t.forEach((function(e){var t=Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2);t<r&&(r=t)})),Math.sqrt(r)}},{key:"getRatingByGroupNameList",value:function(t,a){var r=e.amenitiesList[t],n=e.getMinimalDistanceMetersList(r,a),c=e.calcTimeMinutes(n);return e.calcRating(c)}},{key:"getRatingByGroupNameTree",value:function(t,a){var r=e.amenitiesTree[t],n=e.getMinimalDistanceMetersTree(r,a),c=e.calcTimeMinutes(n);return e.calcRating(c)}}]),e}();O.amenitiesList={},O.amenitiesTree={},O.accepted=["amenity","shop","healthcare","highway"],O.calcCache={metersPerLatDeg:0,metersPerLngDeg:0};a("b65f");var x=function(){function e(){Object(i["a"])(this,e)}return Object(g["a"])(e,null,[{key:"gradient",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultGradient,t=document.createElement("canvas"),a=t.getContext("2d");if(!a)throw new Error("Canvas error");var r=a.createLinearGradient(0,0,0,256);return t.width=1,t.height=256,Object.keys(e).forEach((function(t){return r.addColorStop(+t,e[+t])})),a.fillStyle=r,a.fillRect(0,0,1,256),a.getImageData(0,0,1,256).data}},{key:"drawRating",value:function(e,t,a,r){var n=document.createElement("canvas");n.width=t,n.height=a;var c=n.getContext("2d");if(!c)throw new Error("Canvas error");var i=new ImageData(t,a),o=i.data,s=e[0],u=e[1],l=e[2],p=e[3],h=(l-s)/2/a,f=(p-u)/2/t,g=0;O.cacheDistances(e);for(var m=l-h,d=0;d<a;d++,m-=2*h)for(var v=u+f,y=0;y<t;y++,v+=2*f){var b=O.getAverageRating(r,[m,v]),w=Math.trunc(Math.max(0,Math.min(255,b/5*255))),x=4*w;o[g++]=this._grad[x],o[g++]=this._grad[x+1],o[g++]=this._grad[x+2],o[g++]=this._grad[x+3]}return c.putImageData(i,0,0),n}}]),e}();x.colors=["transparent","blue","cyan","lime","yellow","orange","red"],x.defaultGradient=x.colors.reduce((function(e,t,a,r){return e[a/(r.length-1)]=t,e}),{}),x._grad=x.gradient();var k=function(e){Object(o["a"])(a,e);var t=Object(s["a"])(a);function a(){var e;return Object(i["a"])(this,a),e=t.apply(this,arguments),e.Preferences=d,e.center=[51.6618,39.202],e.lastOverlay=null,e.zoom=13,e.selected_case=0,e.state="Готов",e.tileProvider={attribution:'&copy; <a target="_blank" href="https://osm.org/copyright">OpenStreetMap</a> contributors',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"},e}return Object(g["a"])(a,[{key:"mounted",value:function(){var e=this;this.map=m["map"]("map").setView(this.center,this.zoom),m["tileLayer"](this.tileProvider.url,{attribution:this.tileProvider.attribution}).addTo(this.map),this.map.on("click",(function(t){var a=[t.latlng.lat,t.latlng.lng],r=O.getAverageRating(d.cases[e.selected_case],a);m["popup"]().setLatLng(t.latlng).setContent("<b>Рейтинг: </b>"+r.toFixed(3)).openOn(e.map)}))}},{key:"paint",value:function(){var e=Object(f["a"])(regeneratorRuntime.mark((function e(){var t,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,this.state="Загрузка данных",e.next=4,O.loadAmenities(this.bbox());case 4:e.next=10;break;case 6:e.prev=6,e.t0=e["catch"](0),console.error(e.t0),this.state="Произошла ошибка при загрузке данных";case 10:return t=d.cases[this.selected_case],a=this.map.getSize(),e.prev=12,this.state="Предварительная отрисовка",e.next=16,this.draw(a.x/8|0,a.y/8|0,t);case 16:return this.state="Финальная отрисовка",e.next=19,this.draw(a.x/2|0,a.y/2|0,t);case 19:this.state="Готов",e.next=26;break;case 22:e.prev=22,e.t1=e["catch"](12),console.error(e.t1),this.state="Произошла ошибка при отрисовке данных";case 26:case"end":return e.stop()}}),e,this,[[0,6],[12,22]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"draw",value:function(){var e=Object(f["a"])(regeneratorRuntime.mark((function e(t,a,r){var n,c,i;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n=this.bbox(),c=[[n[0],n[1]],[n[2],n[3]]],e.next=4,new Promise((function(e){return setTimeout((function(){e(x.drawRating(n,t,a,r))}))}));case 4:i=e.sent,this.lastOverlay&&this.lastOverlay.removeFrom(this.map),this.lastOverlay=m["imageOverlay"](i.toDataURL(),c,{opacity:.5}).addTo(this.map);case 7:case"end":return e.stop()}}),e,this)})));function t(t,a,r){return e.apply(this,arguments)}return t}()},{key:"bbox",value:function(){var e=this.map.getBounds();return[e.getSouth(),e.getWest(),e.getNorth(),e.getEast()]}}]),a}(r["a"]);k=Object(u["a"])([Object(l["a"])({})],k);var j=k,_=j,M=a("2877"),R=a("6544"),L=a.n(R),D=a("8336"),S=a("67b6"),P=a("43a6"),T=Object(M["a"])(_,p,h,!1,null,null,null),E=T.exports;L()(T,{VBtn:D["a"],VRadio:S["a"],VRadioGroup:P["a"]});var C=function(e){Object(o["a"])(a,e);var t=Object(s["a"])(a);function a(){return Object(i["a"])(this,a),t.apply(this,arguments)}return a}(r["a"]);C=Object(u["a"])([Object(l["a"])({components:{Home:E}})],C);var N=C,I=N,G=(a("034f"),a("7496")),Q=a("f6c4"),z=Object(M["a"])(I,n,c,!1,null,null,null),A=z.exports;L()(z,{VApp:G["a"],VMain:Q["a"]});var B=a("f309");r["a"].use(B["a"]);var V=new B["a"]({});r["a"].config.productionTip=!1,new r["a"]({vuetify:V,render:function(e){return e(A)}}).$mount("#app")}});
//# sourceMappingURL=app.24fb2a06.js.map